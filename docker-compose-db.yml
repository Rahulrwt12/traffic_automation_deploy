# ============================================================================
# Docker Compose - PostgreSQL Database
# ============================================================================
# This file provides an easy way to run PostgreSQL for Traffic Automation
# 
# Usage:
#   Start:    docker-compose -f docker-compose-db.yml up -d
#   Stop:     docker-compose -f docker-compose-db.yml down
#   Logs:     docker-compose -f docker-compose-db.yml logs -f
#   Shell:    docker exec -it traffic_automation_db psql -U traffic_bot -d traffic_automation

version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: traffic_automation_db
    restart: unless-stopped
    
    # Environment variables
    environment:
      # Database configuration
      POSTGRES_DB: traffic_automation
      POSTGRES_USER: traffic_bot
      POSTGRES_PASSWORD: ${DB_PASSWORD:-traffic_bot_password_change_me}
      
      # Performance tuning
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=en_US.UTF-8"
      
      # Connection limits
      POSTGRES_MAX_CONNECTIONS: 200
      
    # Ports (expose PostgreSQL to host)
    ports:
      - "5432:5432"
    
    # Volumes (persist data + load schema)
    volumes:
      # Data persistence (CRITICAL - keeps data across restarts)
      - postgres_data:/var/lib/postgresql/data
      
      # Auto-load schema on first start
      - ./database_schema.sql:/docker-entrypoint-initdb.d/01_schema.sql:ro
      
      # Optional: Custom PostgreSQL configuration
      # - ./postgresql.conf:/etc/postgresql/postgresql.conf:ro
    
    # Health check
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U traffic_bot -d traffic_automation"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    
    # Resource limits (adjust based on your server)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Optional: pgAdmin (Database Management UI)
  # Uncomment to enable web-based database management
  # pgadmin:
  #   image: dpage/pgadmin4:latest
  #   container_name: traffic_automation_pgadmin
  #   restart: unless-stopped
  #   environment:
  #     PGADMIN_DEFAULT_EMAIL: admin@traffic-automation.local
  #     PGADMIN_DEFAULT_PASSWORD: admin_password_change_me
  #     PGADMIN_LISTEN_PORT: 5050
  #   ports:
  #     - "5050:5050"
  #   volumes:
  #     - pgadmin_data:/var/lib/pgadmin
  #   depends_on:
  #     - postgres

# Named volumes for data persistence
volumes:
  postgres_data:
    driver: local
    # Optional: specify local path
    # driver_opts:
    #   type: none
    #   device: /path/to/postgres/data
    #   o: bind
  
  # pgadmin_data:
  #   driver: local

# ============================================================================
# QUICK REFERENCE
# ============================================================================
#
# Start PostgreSQL:
#   docker-compose -f docker-compose-db.yml up -d
#
# Stop PostgreSQL:
#   docker-compose -f docker-compose-db.yml down
#
# View logs:
#   docker-compose -f docker-compose-db.yml logs -f postgres
#
# Connect to database:
#   docker exec -it traffic_automation_db psql -U traffic_bot -d traffic_automation
#
# Run SQL file:
#   docker exec -i traffic_automation_db psql -U traffic_bot -d traffic_automation < yourfile.sql
#
# Backup database:
#   docker exec traffic_automation_db pg_dump -U traffic_bot traffic_automation > backup_$(date +%Y%m%d).sql
#
# Restore database:
#   docker exec -i traffic_automation_db psql -U traffic_bot -d traffic_automation < backup.sql
#
# Check health:
#   docker-compose -f docker-compose-db.yml ps
#   docker exec traffic_automation_db pg_isready -U traffic_bot -d traffic_automation
#
# ============================================================================
# CONFIGURATION
# ============================================================================
#
# After starting PostgreSQL, add to your .env file:
#
#   DATABASE_URL=postgresql://traffic_bot:traffic_bot_password_change_me@localhost:5432/traffic_automation
#
# And in config.json, set:
#
#   "database": {
#     "enabled": true
#   }
#
# ============================================================================

